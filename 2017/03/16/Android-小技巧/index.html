<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 利用工具排查Android疑难crash · EvilsoulM</title><meta name="description" content="利用工具排查Android疑难crash - EvilsoulM"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://evilsoulm.com/atom.xml" title="EvilsoulM"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://www.weibo.com/1895866907" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/EvilsoulM" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">利用工具排查Android疑难crash</h1><div class="post-info">Mar 16, 2017</div><div class="post-content"><p>利用工具排查Android疑难crash </p>
<h3 id="精准定位线上代码段"><a href="#精准定位线上代码段" class="headerlink" title="精准定位线上代码段"></a>精准定位线上代码段</h3><p>当版本发布很频繁或者利用相同版本号灰度导致同一个版本的代码有可能不同的这种情况下，我们查一些线上问题就有可能不能精准定位到crash真实发生的代码行数。</p>
<p>我们可以利用gradle在中加入一些函数利用gradle中buildConfigField这个字段把git的信息和分支名带入到apk中，或者上报到自己的crash平台上这样我们就可以利用git SHA值还有分支名很快能够定位到crash的代码行数，并且也能够知道大概是谁的分支产生的crash</p>
<h4 id="1-在自己项目的gradle中加入-底下三个方法"><a href="#1-在自己项目的gradle中加入-底下三个方法" class="headerlink" title="1.在自己项目的gradle中加入 底下三个方法"></a>1.在自己项目的gradle中加入 底下三个方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">def getVersionName = &#123; -&gt;</div><div class="line">    def stdout = new ByteArrayOutputStream()</div><div class="line">    exec &#123;</div><div class="line">        commandLine &apos;sh&apos;, &apos;-c&apos;, &apos;git rev-list HEAD | wc -l | awk \&apos;&#123;print $1&#125;\&apos;&apos;</div><div class="line">        standardOutput = stdout</div><div class="line">    &#125;</div><div class="line">    return stdout.toString().trim()</div><div class="line">&#125;</div><div class="line"></div><div class="line">def getGitSha = &#123; -&gt;</div><div class="line">    def stdout = new ByteArrayOutputStream()</div><div class="line">    exec &#123;</div><div class="line">        commandLine &apos;sh&apos;, &apos;-c&apos;, &apos;git rev-parse --short HEAD&apos;</div><div class="line">        standardOutput = stdout</div><div class="line">    &#125;</div><div class="line">    return stdout.toString().trim()</div><div class="line">&#125;</div><div class="line"></div><div class="line">def getGitBranch = &#123; -&gt;</div><div class="line">    def stdout = new ByteArrayOutputStream()</div><div class="line">    exec &#123;</div><div class="line">        commandLine &apos;sh&apos;, &apos;-c&apos;, &apos;git rev-parse --abbrev-ref HEAD&apos;</div><div class="line">        standardOutput = stdout</div><div class="line">    &#125;</div><div class="line">    return stdout.toString().trim()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>####在defaultConfig增加下面字段<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">buildConfigField &quot;String&quot;, &quot;BUILD_CODE&quot;, &quot;\&quot;&quot; + getVersionName() + &quot;\&quot;&quot;</div><div class="line">      buildConfigField &quot;String&quot;, &quot;GIT_SHA&quot;, &quot;\&quot;&quot; + getGitSha() + &quot;\&quot;&quot;</div><div class="line">      buildConfigField &quot;String&quot;, &quot;GIT_BRANCH&quot;, &quot;\&quot;&quot; + getGitBranch() + &quot;\&quot;&quot;</div></pre></td></tr></table></figure></p>
<p>####然后再编译后在BuildConfig这个类中就会多出这三个字端，我们直接调用就可以了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">public final class BuildConfig &#123;</div><div class="line">  public static final String VERSION_NAME = &quot;1.3.3&quot;;</div><div class="line">  public static final String GIT_BRANCH = &quot;develop_evilsoulm_future________&quot;;</div><div class="line">  public static final String GIT_SHA = &quot;4b4790c&quot;;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>###利用ANR-WatchDog上报ANR日志</p>
<p>ANR一直是一个比较难排查和难察觉的问题，用户也去分不清楚anr和crash，并且anr在一般的crash收集平台都是采集不到的。想要解决线上anr一般只能靠联系用户复现，或者去抓取用户的trace文件，一般都是比较被动的方式，用户上报才回去解决，无法主动排查解决。</p>
<p><a href="https://github.com/SalomonBrys/ANR-WatchDog" target="_blank" rel="external">ANR-WatchDog</a> 这个开源库就可以在运行时主动排查ANR。</p>
<p>####原理<br>代码也比较少，原理也很简单，新开一个线程一直向主线程发消息，让主线程的int值改变，如果5秒（或者自定义的时间）内主线程的值没有改变也就说明线程被block住了，收集当前的堆栈信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">while (!isInterrupted()) &#123;</div><div class="line">            lastTick = _tick;</div><div class="line">            //向主线程发消息</div><div class="line">            _uiHandler.post(_ticker);</div><div class="line">            try &#123;</div><div class="line">                Thread.sleep(_timeoutInterval);</div><div class="line">            &#125;</div><div class="line">            catch (InterruptedException e) &#123;</div><div class="line">                _interruptionListener.onInterrupted(e);</div><div class="line">                return ;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            // If the main thread has not handled _ticker, it is blocked. ANR.</div><div class="line">            ／／前面发的消息就是修改主线程的值，如果值没有改变的话就说明主线程被改变了</div><div class="line">            if (_tick == lastTick) &#123;</div><div class="line">                if (!_ignoreDebugger &amp;&amp; Debug.isDebuggerConnected()) &#123;</div><div class="line">                    if (_tick != lastIgnored)</div><div class="line">                        Log.w(&quot;ANRWatchdog&quot;, &quot;An ANR was detected but ignored because the debugger is connected (you can prevent this with setIgnoreDebugger(true))&quot;);</div><div class="line">                    lastIgnored = _tick;</div><div class="line">                    continue ;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                ANRError error;</div><div class="line">                if (_namePrefix != null)</div><div class="line">                    error = ANRError.New(_namePrefix, _logThreadsWithoutStackTrace);</div><div class="line">                else</div><div class="line">                    error = ANRError.NewMainOnly();</div><div class="line">                _anrListener.onAppNotResponding(error);</div><div class="line">                return;</div><div class="line">            &#125;</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>####使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">int anrTimeOut = 30 * 1000;//在Release的时候可以提高一些时常。</div><div class="line">        if (BuildConfig.DEBUG) &#123;</div><div class="line">            anrTimeOut = 5 * 1000;／／在内部测试使用的时候条件可以严苛一点，提高代码质量</div><div class="line">        &#125;</div><div class="line"> new ANRWatchDog(anrTimeOut).setANRListener(new ANRMonitor.ANRListener() &#123;</div><div class="line">            @Override</div><div class="line">            public void onAppNotResponding(ANRError error) &#123;</div><div class="line">                if (DebugConfig.isOpen()) &#123;</div><div class="line">                    throw error;／／在内部使用的时候可以主动让程序crash方便开发人员排查</div><div class="line">                &#125; else &#123;</div><div class="line">                //线上则可以上报到自己的crash平台，来线上主动发现问题排查问题</div><div class="line">                    Crashlytics.logException(error);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;).start();</div></pre></td></tr></table></figure>
<p>###利用Fabric排查线上疑难问题</p>
<p><a href="https://fabric.io" target="_blank" rel="external">fabric</a>是一个类似于国内的友盟是一个移动信息收集平台，里面比较好用的功能就是Crash信息收集系统Crashlytics。</p>
<p>####排查疑难crash<br>有的时候用户的crash信息有可能是一些系统层的堆栈信息，我们难以定位到用户的操作路径和用户发生crash的页面，比如下面这种crash基本上拿到就是处于懵逼的状态。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Fatal Exception: java.lang.NullPointerException: Attempt to invoke virtual method &apos;boolean android.support.v7.widget.RecyclerView$LayoutManager.canScrollVertically()&apos; on a null object reference</div><div class="line">       at android.support.v7.widget.RecyclerView.computeVerticalScrollOffset(RecyclerView.java:1540)</div><div class="line">       at android.view.View.canScrollVertically(View.java:13860)</div><div class="line">       at android.support.v4.view.ViewCompatICS.canScrollVertically(ViewCompatICS.java:35)</div><div class="line">       at android.support.v4.view.ViewCompat$ICSViewCompatImpl.canScrollVertically(ViewCompat.java:1338)</div><div class="line">       at android.support.v4.view.ViewCompat.canScrollVertically(ViewCompat.java:1840)</div><div class="line">       at android.support.v4.widget.SwipeRefreshLayout.canChildScrollUp(SwipeRefreshLayout.java:673)</div><div class="line">       at android.support.v4.widget.SwipeRefreshLayout.onInterceptTouchEvent(SwipeRefreshLayout.java:697)</div><div class="line">       at android.view.ViewGroup.dispatchTouchEvent(ViewGroup.java:2108)</div></pre></td></tr></table></figure>
<p>像这种我们就可以利用crashlytics的日志上报功能上报用户的行为路径到Fabric上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public class AmeActivity extends AmeBaseComponentActivity &#123;</div><div class="line"></div><div class="line">       @Override</div><div class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">        super.onCreate(savedInstanceState);</div><div class="line">        //在基类中上报用户的当前页面名称</div><div class="line">             CrashlyticsWrapper.log(&quot;当前页面：&quot; + this.getClass().getSimpleName());</div></pre></td></tr></table></figure>
<p>效果<br><img src="http://oacl4nhb6.bkt.clouddn.com/B20C7DDC-AE82-4A2F-8C68-C5B9CAE21A95.png"></p>
<p>这样我们就可以清楚的知道用户的操作路径并且可以定位到最后发生crash的页面</p>
<p>当然我们也可以上报一些其他的信息上来，来帮定位crash<br><img src="http://oacl4nhb6.bkt.clouddn.com/crash_info.png
"></p>
<p>####定位Native crash<br>crashlytics也是支持native crash收集上报的</p>
<p>一般我们看的crash信息就是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Crashed: droid.ugc.aweme</div><div class="line">0  libffmpeg.so                                                0xd0e20048 av_read_frame</div><div class="line">1  libffmpeg-invoker.so                                        0xd525ff71 playAudioSamples</div><div class="line">2  libffmpeg-invoker.so                                        0xd5256055 Java_com_ss_android_medialib_FFMpegInvoker_playAudioSamples</div><div class="line">3  data@app@com.ss.android.ugc.aweme-2@base.apk@classes.dex    0xe1f02ef7 (Missing)</div></pre></td></tr></table></figure>
<p>只能定位到某个方法crash了但是无法定位到方法中的行数，当然如果上传了ndk的符号表上去，就可以定位到crash行数，当然也可以比较蠢，利用日志上报来定位<a href="https://docs.fabric.io/android/crashlytics/ndk.html" target="_blank" rel="external">https://docs.fabric.io/android/crashlytics/ndk.html</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/08/04/Java代码优化技巧/" class="next">NEXT</a></div><div data-thread-key="2017/03/16/Android-小技巧/" data-title="利用工具排查Android疑难crash" data-url="http://evilsoulm.com/2017/03/16/Android-小技巧/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"seansun"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2015 - 2017 <a href="http://evilsoulm.com">EvilsoulM</a>, unless otherwise noted.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>